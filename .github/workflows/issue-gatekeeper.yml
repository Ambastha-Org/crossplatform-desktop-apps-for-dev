name: "ğŸ›¡ï¸ Issue Gatekeeper"

on:
  issues:
    types: [opened, edited, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "The issue number to process (used by Recovery)"
        required: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  gatekeeper:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸšš Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: "ğŸ“‘ Initial Parse"
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./scripts/issue_aggregator.js');
            await script({github, context, core});

      - name: "ğŸ” Remote ID Verification"
        shell: bash
        run: |
          chmod +x ./scripts/remote_verify.sh
          ./scripts/remote_verify.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REQ_WIN_ID: ${{ env.REQ_WIN_ID }}
          REQ_BREW_ID: ${{ env.REQ_BREW_ID }}

      - name: "ğŸ’¾ Finalize & Update Registry"
        env:
          WIN_DATA: ${{ env.WIN_DATA }}
          BREW_DATA: ${{ env.BREW_DATA }}
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./scripts/issue_aggregator.js');
            await script({github, context, core});

      - name: "ğŸ§ª Apply Sorting, SemVer & README Update"
        if: hashFiles('apply_signal.json') != ''
        run: |
          python scripts/reformat_json.py

      - name: "ğŸš€ Create/Update Pull Request"
        if: hashFiles('apply_signal.json') != ''
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          add-paths: |
            os_tools.json
            README.md
          branch: "automated-tool-updates"
          title: "ğŸš€ [Registry Update] Batch Tool Additions & Maintenance"
          commit-message: "chore: update registry & readme to v$(jq -r '.metadata.version' os_tools.json)"
          body: |
            ### ğŸ¤– Automated Registry Update
            Triggered by Issue #${{ github.event.inputs.issue_number || github.event.issue.number }}.

            - **Action:** ${{ env.CHANGE_TYPE == 'minor' && 'New Tool Addition' || 'Tool Fix/Update' }}
            - **Tool:** ${{ env.TOOL_NAME }}
            - **Status:** Verified âœ…
            - **Version:** v$(jq -r '.metadata.version' os_tools.json)

      - name: "ğŸ”— Comment PR Link on Issue"
        if: steps.cpr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = "${{ steps.cpr.outputs.pull-request-number }}";
            await require('./scripts/comment_pr_link.js')({github, context, prNumber});
