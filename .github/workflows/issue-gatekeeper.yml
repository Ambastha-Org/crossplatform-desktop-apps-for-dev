name: "ðŸ›¡ï¸ Issue Gatekeeper"

on:
  issues:
    types: [opened, edited, reopened]
  workflow_dispatch:
    inputs:
      tool_name:
        description: "ðŸ“› Tool Name"
        required: true
      winget_id:
        description: "ðŸªŸ WinGet ID"
        required: true
      brew_id:
        description: "ðŸŽ Homebrew ID"
        required: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  setup:
    name: "ðŸ§  Unified Parsing"
    runs-on: ubuntu-latest
    outputs:
      win_id: ${{ github.event.inputs.winget_id || steps.parse.outputs.win_id }}
      brew_id: ${{ github.event.inputs.brew_id || steps.parse.outputs.brew_id }}
      tool_name: ${{ github.event.inputs.tool_name || steps.parse.outputs.tool_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Labels Exist
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const labels = ['ðŸš« duplicate','âœ… auto-verified','ðŸ”¥ confirmed-broken','ðŸ§ª needs-verification','âœ¨ new-tool','ðŸš¨ bug','âš¡ priority'];
            for (const name of labels) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (e) {
                await github.rest.issues.createLabel({ owner, repo, name, color: 'ededed' });
              }
            }

      - name: Parse YAML & Check Duplicates
        id: parse
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./scripts/issue_aggregator.js');
            await script({github, context, core});
            core.setOutput('win_id', process.env.REQ_WIN_ID || '');
            core.setOutput('brew_id', process.env.REQ_BREW_ID || '');
            core.setOutput('tool_name', process.env.TOOL_NAME || '');

  verify:
    name: "ðŸ” Verification"
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: winget
            script: "scripts/verify_winget.ps1"
          - os: macos-latest
            platform: homebrew
            script: "scripts/verify_brew.sh"
    runs-on: ${{ matrix.os }}
    env:
      REQ_WIN_ID: ${{ needs.setup.outputs.win_id }}
      REQ_BREW_ID: ${{ needs.setup.outputs.brew_id }}
    outputs:
      win_data: ${{ steps.capture.outputs.win_data }}
      brew_data: ${{ steps.capture.outputs.brew_data }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Verification (Windows)
        if: matrix.os == 'windows-latest'
        id: run_script_win
        shell: pwsh
        run: |
          Write-Host "Running ${{ matrix.script }} on Windows"
          & ./${{ matrix.script }} | Out-File -FilePath output.txt -Encoding utf8
          Get-Content output.txt

      - name: Run Verification (macOS)
        if: matrix.os == 'macos-latest'
        id: run_script_mac
        shell: bash
        run: |
          echo "Running ${{ matrix.script }} on macOS"
          chmod +x ./${{ matrix.script }}
          ./${{ matrix.script }} > output.txt
          cat output.txt

      - name: Capture JSON Result
        id: capture
        shell: bash
        run: |
          DATA=$(grep "RESULT_JSON=" output.txt | sed 's/RESULT_JSON=//')
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo "win_data=$DATA" >> $GITHUB_OUTPUT
          else
            echo "brew_data=$DATA" >> $GITHUB_OUTPUT
          fi

  aggregate:
    name: "ðŸ”— Process & Respond"
    needs: [setup, verify]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Finalize Issue Status
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        env:
          WIN_DATA: ${{ needs.verify.outputs.win_data }}
          BREW_DATA: ${{ needs.verify.outputs.brew_data }}
        with:
          script: |
            const script = require('./scripts/issue_aggregator.js');
            await script({github, context, core});

      - name: "ðŸš€ Run PR Logic (LOCAL TEST)"
        env:
          W_DATA: ${{ needs.verify.outputs.win_data }}
          B_DATA: ${{ needs.verify.outputs.brew_data }}
        run: |
          sanitize_json() {
            local input="$1"

            if echo "$input" | jq -e . >/dev/null 2>&1; then
              echo "$input"
            else
              echo '{"found":false}'
            fi
          }

          W_DATA=$(sanitize_json "$W_DATA")
          B_DATA=$(sanitize_json "$B_DATA")

          WIN_SUG=$(echo "$W_DATA" | jq -r '.suggestion // ""')
          BREW_SUG=$(echo "$B_DATA" | jq -r '.suggestion // ""')

          WIN_SUG=$(echo "$W_DATA" | jq -r '.suggestion // ""')
          BREW_SUG=$(echo "$B_DATA" | jq -r '.suggestion // ""')

          echo "{\"win_id\":\"$WIN_SUG\",\"brew_id\":\"$BREW_SUG\",\"name\":\"${{ needs.setup.outputs.tool_name }}\"}" > /tmp/entry.json

          python3 scripts/add_tool_entry.py /tmp/entry.json
          python3 scripts/reformat_json.py

      - name: "ðŸ“¤ Create or Update PR"
        if: |
          success() && 
          (contains(needs.verify.outputs.win_data, '"found": true') || 
           contains(needs.verify.outputs.brew_data, '"found": true'))
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "automated-tool-updates"
          commit-message: "feat: update os_tools.json via Registry-Bot ðŸ¤–"
          title: "ðŸš€ [Automated] New Tool Proposals"
          body: "Verified tool requests processing. Automated sorting applied."
          delete-branch: false
