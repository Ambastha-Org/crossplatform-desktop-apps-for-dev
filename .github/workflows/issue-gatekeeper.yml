name: "ðŸ›¡ï¸ Issue Gatekeeper"

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  gatekeeper:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Initial Parse"
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./scripts/issue_aggregator.js');
            await script({github, context, core});

      - name: "Verify IDs"
        run: |
          # WinGet Check
          WIN_RES=$(curl -s "https://api.github.com/search/code?q=filename:${{ env.REQ_WIN_ID }}+repo:microsoft/winget-pkgs" | jq '.total_count // 0')
          if [ "$WIN_RES" -gt 0 ]; then echo "WIN_DATA={\"found\":true}" >> $GITHUB_ENV; fi

          # Brew Check
          BREW_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://formulae.brew.sh/api/formula/${{ env.REQ_BREW_ID }}.json)
          if [ "$BREW_CODE" == "200" ]; then echo "BREW_DATA={\"found\":true}" >> $GITHUB_ENV; fi

      - name: "Finalize & PR Signal"
        env:
          WIN_DATA: ${{ env.WIN_DATA }}
          BREW_DATA: ${{ env.BREW_DATA }}
        run: node -e "require('./scripts/issue_aggregator.js')({github, context, core})"

      - name: "ðŸš€ Create PR"
        if: hashFiles('/tmp/apply.json') != ''
        uses: peter-evans/create-pull-request@v5
        with:
          branch: "automated-tool-updates"
          title: "ðŸš€ [Ambastha] Add ${{ env.TOOL_NAME }}"
          commit-message: "feat: automated registry update for ${{ env.TOOL_NAME }}"
          body: "Verified by Ambastha-Org Gatekeeper."
