name: "ðŸ›¡ï¸ Issue Gatekeeper"

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  gatekeeper:
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸšš Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ Set up Python"
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: "ðŸ“‘ Initial Parse"
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./scripts/issue_aggregator.js');
            await script({github, context, core});

      - name: "ðŸ” Verify IDs (WinGet & Brew)"
        run: |
          # ðŸªŸ WinGet Path Verification
          # Convert "Publisher.Tool" to "manifests/p/Publisher/Tool"
          ID="${{ env.REQ_WIN_ID }}"
          if [ ! -z "$ID" ]; then
            FIRST_LETTER=$(echo "${ID:0:1}" | tr '[:upper:]' '[:lower:]')
            PART_PATH=$(echo "$ID" | tr '.' '/')
            WIN_URL="https://api.github.com/repos/microsoft/winget-pkgs/contents/manifests/$FIRST_LETTER/$PART_PATH"
            
            # Using GITHUB_TOKEN to avoid rate limits
            WIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "$WIN_URL")
            
            if [ "$WIN_STATUS" == "200" ]; then 
              echo "WIN_DATA={\"found\":true}" >> $GITHUB_ENV
            fi
          fi

          # ðŸŽ Brew Formula/Cask Verification
          BREW_ID="${{ env.REQ_BREW_ID }}"
          if [ ! -z "$BREW_ID" ]; then
            B_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://formulae.brew.sh/api/formula/${BREW_ID}.json")
            C_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://formulae.brew.sh/api/cask/${BREW_ID}.json")
            
            if [ "$B_CODE" == "200" ] || [ "$C_CODE" == "200" ]; then 
              echo "BREW_DATA={\"found\":true}" >> $GITHUB_ENV
            fi
          fi

      - name: "ðŸ’¾ Finalize & Update Registry"
        env:
          WIN_DATA: ${{ env.WIN_DATA }}
          BREW_DATA: ${{ env.BREW_DATA }}
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./scripts/issue_aggregator.js');
            await script({github, context, core});

      - name: "ðŸ§ª Apply Sorting & SemVer"
        if: hashFiles('apply_signal.json') != ''
        run: |
          python scripts/reformat_json.py

      - name: "ðŸš€ Create Pull Request"
        if: hashFiles('apply_signal.json') != ''
        uses: peter-evans/create-pull-request@v5
        with:
          add-paths: os_tools.json
          branch: "automated-tool-updates"
          title: "ðŸš€ [tools] Add ${{ env.TOOL_NAME }}"
          commit-message: "feat: automated registry update for ${{ env.TOOL_NAME }}"
          body: |
            ### ðŸ¤– Automated Registry Update
            - **Tool:** ${{ env.TOOL_NAME }}
            - **Status:** Verified on WinGet & Brew âœ…
            - **Version:** Auto-bumped based on change type.
            - **Registry:** Sorted alphabetically by ID.

            Verified by Ambastha-Org Gatekeeper.
