name: "üõ°Ô∏è Registry Gatekeeper"

on:
  pull_request:
    paths:
      - "os_tools.json"

jobs:
  verify-ids:
    name: "üîç Verify & Suggest Fix"
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: "üöö Checkout Repository"
        uses: actions/checkout@v4

      - name: Ensure Labels Exist
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const labels = ['üö´ duplicate','‚úÖ auto-verified','üî• confirmed-broken','üß™ needs-verification','‚ú® new-tool','üö® bug'];
            for (const name of labels) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (e) {
                await github.rest.issues.createLabel({ owner, repo, name, color: 'ededed' });
              }
            }

      - name: "ü™ü WinGet Verification"
        if: matrix.os == 'windows-latest'
        id: winget_check
        shell: pwsh
        run: |
          ./scripts/verify_winget.ps1
          $out = Get-Content output.txt | Out-String
          if ($out -match "RESULT_JSON=(.*)") {
            $json = $matches[1] | ConvertFrom-Json
            echo "found=$($json.found)" >> $env:GITHUB_OUTPUT
            echo "suggestion=$($json.suggestion)" >> $env:GITHUB_OUTPUT
          }

      - name: "üçé Homebrew Verification"
        if: matrix.os == 'macos-latest'
        id: brew_check
        shell: bash
        run: |
          chmod +x ./scripts/verify_brew.sh
          ./scripts/verify_brew.sh > output.txt
          DATA=$(grep "RESULT_JSON=" output.txt | sed 's/RESULT_JSON=//')
          echo "found=$(echo $DATA | jq -r .found)" >> $env:GITHUB_OUTPUT
          echo "suggestion=$(echo $DATA | jq -r .suggestion)" >> $env:GITHUB_OUTPUT

      - name: "ü§ñ Post Suggestion"
        if: steps.winget_check.outputs.found == 'false' || steps.brew_check.outputs.found == 'false'
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ### ü§ñ Registry-Bot Auto-Fix Suggestion
            An ID provided for **${{ matrix.os }}** was not found ‚ùå.

            **Suggested ID:** `${{ steps.winget_check.outputs.suggestion }}${{ steps.brew_check.outputs.suggestion }}` ‚ú®

            ```suggestion
            "${{ matrix.os == 'windows-latest' && 'win32' || 'darwin' }}": "${{ steps.winget_check.outputs.suggestion }}${{ steps.brew_check.outputs.suggestion }}"
            ```
