name: "üõ°Ô∏è Registry Gatekeeper"

on:
  pull_request:
    paths:
      - "os_tools.json"

jobs:
  verify-ids:
    name: "üîç Verify & Suggest Fix"
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      pull-requests: write
    steps:
      - name: "üöö Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ü™ü WinGet Verification"
        if: matrix.os == 'windows-latest'
        id: winget_check
        shell: pwsh
        run: |
          Write-Host "üöÄ Scanning for Win32 ID changes..."
          $changed = git diff origin/main -U0 os_tools.json | Select-String '"win32":\s*"([^"]+)"'
          foreach ($match in $changed) {
            $id = $match.Matches.Groups[1].Value
            Write-Host "üîé Testing: $id"
            winget show --id $id --accept-source-agreements
            if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ùå ID Not Found. Searching for alternatives..."
              $search = winget search $id | Select-Object -Skip 4 -First 1 | ForEach-Object { $_.split(' ')[0] }
              echo "suggestion=$search" >> $env:GITHUB_OUTPUT
              echo "failed_id=$id" >> $env:GITHUB_OUTPUT
              exit 1
            }
          }
          Write-Host "‚úÖ All WinGet IDs verified."

      # MACOS LOGIC
      - name: "üçé Homebrew Verification"
        if: matrix.os == 'macos-latest'
        id: brew_check
        run: |
          echo "üöÄ Scanning for Darwin ID changes..."
          CHANGED_IDS=$(git diff origin/main -U0 os_tools.json | grep -oP '"darwin":\s*"\K[^"]+')
          for id in $CHANGED_IDS; do
            echo "üîé Testing: $id"
            if ! brew info --cask $id >/dev/null 2>&1 && ! brew info $id >/dev/null 2>&1; then
              echo "‚ùå ID Not Found. Searching for alternatives..."
              SUGGESTION=$(brew search $id | head -n 1)
              echo "suggestion=$SUGGESTION" >> $GITHUB_OUTPUT
              echo "failed_id=$id" >> $GITHUB_OUTPUT
              exit 1
            fi
          done
          echo "‚úÖ All Homebrew IDs verified."

      - name: "ü§ñ Post Suggestion"
        if: failure()
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ### ü§ñ Registry-Bot Auto-Fix Suggestion
            The ID you provided was not found on **${{ matrix.os }}** ‚ùå.

            **Original ID:** `${{ steps.winget_check.outputs.failed_id }}${{ steps.brew_check.outputs.failed_id }}`
            **Suggested ID:** `${{ steps.winget_check.outputs.suggestion }}${{ steps.brew_check.outputs.suggestion }}` ‚ú®

            ```suggestion
            "${{ matrix.os == 'windows-latest' && 'win32' || 'darwin' }}": "${{ steps.winget_check.outputs.suggestion }}${{ steps.brew_check.outputs.suggestion }}"
            ```
            *Please verify this suggestion and click **Commit suggestion** to fix the PR!*
